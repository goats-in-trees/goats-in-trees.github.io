<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="icon" href="/assets/images/goat-logo.png">

    <title>Convert an old PHP application to Docker containers | Goats in Trees</title>

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Convert an old PHP application to Docker containers | Goats in Trees</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Convert an old PHP application to Docker containers" />
<meta name="author" content="davelms" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Backstory" />
<meta property="og:description" content="Backstory" />
<meta property="og:site_name" content="Goats in Trees" />
<meta property="og:image" content="/assets/images/convert-an-old-php-application-to-docker-containers/1_aE5KJkbslMZO6Zid9JSLiw.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-19T09:03:07+00:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"/convert-an-old-php-application-to-docker-containers/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/goat-logo.png"},"name":"davelms"},"headline":"Convert an old PHP application to Docker containers","dateModified":"2020-04-19T09:03:07+00:00","datePublished":"2020-04-19T09:03:07+00:00","image":"/assets/images/convert-an-old-php-application-to-docker-containers/1_aE5KJkbslMZO6Zid9JSLiw.png","author":{"@type":"Person","name":"davelms"},"description":"Backstory","mainEntityOfPage":{"@type":"WebPage","@id":"/convert-an-old-php-application-to-docker-containers/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link href="/assets/css/prism.css" rel="stylesheet">

    <link href="/assets/css/theme.css" rel="stylesheet">

    <script src="/assets/js/jquery.min.js"></script>

</head>


<!-- change your GA id in _config.yml -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-209086-18"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-209086-18');
</script>




<body>
    <!-- defer loading of font and font awesome -->
    <noscript id="deferred-styles">
        <link href="https://fonts.googleapis.com/css?family=Sen:400,700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
            integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    </noscript>

    <!-- Begin Sidebar Navigation
================================================== -->

    <div class="sidebar">
    </div>
    <div class="nav-icon">
        <div class="hamburger-bar"></div>
    </div>
    <div id="blackover-nav" class="blackover"></div>
    <nav id="menu">
        <ul>
            <h3>Navigation</h3>
            <li><a href="/">Home</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/contact">Contact</a></li>
        </ul>
    </nav>

    <script src="/assets/js/lunr.js"></script>

<style>
    
</style>

<div class="wrap-search">
    <div class="d-flex align-items-center ml-auto">
        <i class="fas fa-search show-search"></i>
        <form class="bd-search ml-3" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
            <input type="text" class="form-control bigradius text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
        </form>
    </div>
</div>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>


    <!-- End Sidebar Navigation
================================================== -->

    <div class="site-content ">

        <div class="container">

            <!-- Site Logo/Name
    ================================================== -->

            <a class="navbar-brand" href="/">
                <img src="/assets/images/goat-logo.png" alt="Goats in Trees">
            </a>


            <!-- Site Tag
    ================================================== -->
            

            <!-- Content
    ================================================== -->
            <div class="main-content">
                <div class="entry-header">
    <!-- Post Title -->
    <h1 class="posttitle">Convert an old PHP application to Docker containers</h1>
    <!-- Author & Date  Box -->
    
    
    <div class="d-flex align-items-center mt-4">
        <div>
            
            <img class="author-thumb" src="https://www.gravatar.com/avatar/519b6d839ac5d2ae8bdaa85b8152da40?s=250&d=mm&r=x"
                alt="Dave">
            
        </div>
        <div>
            Written by <a target="_blank" class="text-dark" href="https://www.davelms.co.uk">Dave</a> on
            <span class="post-date"><time class="post-date"
                    datetime="2020-04-19">19 Apr 2020</time></span>
            
        </div>
    </div>
    
</div>

<!-- Adsense under title if enabled from _config.yml (change your pub id and slot) -->


<!-- Featured Image -->

<div class="entry-featured-image">
    
    <img class="featured-image "
        src="/assets/images/convert-an-old-php-application-to-docker-containers/1_aE5KJkbslMZO6Zid9JSLiw.png"
        alt="Convert an old PHP application to Docker containers">
    
    
</div>


<!-- Subtitle -->

<div class="article-post">
    <h2 class="subtitle"> Take an old PHP 5 web application and convert it to Docker containers, using the latest PHP 7, Composer, Node.js, Grunt, and Bower. </h2>
</div>


<!-- Content -->
<!-- Post, Page Content
================================================== -->
<div class="article-post">
    <!-- Toc if any -->
    
    <!-- End Toc -->
    <h2 id="backstory">Backstory</h2>

<p><a href="https://www.php.net/">PHP</a> was always the go-to language for me. I started exploring PHP in 2000, around the time of PHP 4 launch, in an effort to convert an increasingly popular website that was written as lots of individual, static HTML pages. I began work on writing a Content Management System from scratch, and the CMS was still distributing 30,000 articles some 17 years later.</p>

<p>This walk through is about another PHP application — it was written using the latest PHP 5 features at the time, and was left happily running in a single Amazon EC2 “classic” instance since 2015.</p>

<p>When I started this migration, the last commit was July 30th 2016.</p>

<h2 id="existing-platform">Existing platform</h2>

<p>The frontend was left running a variety of third party libraries, notably <a href="https://getbootstrap.com/">Bootstrap</a> 3.3 and <a href="https://jquery.com/">jQuery</a> 2.2.</p>

<p>The server-side was <a href="https://symfony.com/">Symfony</a> 3.1 and templates were <a href="https://twig.symfony.com/">Twig</a> 1.x.</p>

<p>Data was obtained from an external API using <em>guzzle</em> and locally cached using <em>doctrine cache</em> 1.6. Logging was done with <em>monolog</em>.</p>

<p>Build toolkit included <a href="https://nodejs.org/">Node.js</a> for npm (package manager), <a href="https://gruntjs.com/">Grunt</a> (javascript task runner), and <a href="https://bower.io/">Bower</a> (web package manager).</p>

<p>CSS stylesheets were written in sass, so we included a parser to create css, concatenate, and minimize. Javascript was consolidated, obfuscated (“uglified”), and also minified.</p>

<p>To get a feel for the build steps, here’s the “build-all” grunt task:</p>

<pre><code class="language-js">grunt.registerTask('build-all', ['clean:all', 'concat', 'uglify', 'sass', 'cssmin', 'bowercopy', 'copy', 'string-replace:version', 'composer:dist:install:optimize-autoloader', 'composer:dist:update:optimize-autoloader']);
</code></pre>

<p>And finally, as you can see from the above, I was using <a href="https://getcomposer.org/">Composer</a> for PHP dependency management.</p>

<p>And finally the server itself was using Nginx with php-fpm.</p>

<p>Everything was stuck in the year 2015. My development server had long since been destroyed. I couldn’t do any changes; I didn’t even have PHP installed any more.</p>

<h2 id="aspiration">Aspiration</h2>

<ul>
  <li>
    <p>Upgrade front end to the latest versions of Bootstrap and jQuery.</p>
  </li>
  <li>
    <p>Update server side runtime libraries to the latest version — apply necessary code changes required as a result, but no other functional changes.</p>
  </li>
  <li>
    <p>Upgrade the built-kit to the latest versions — but no other changes to the tasks or tools used.</p>
  </li>
  <li>
    <p>Deploy to an up-to-date operating system, with PHP 7.x.</p>
  </li>
</ul>

<p>My overarching constraint for the above was that I didn’t want to have to work through and recreate an entire development platform to do it. I wanted to find a way I could achieve the upgrade without needing to stack my Windows laptop with grunt, bower, nodejs, composer, PHP, just for this one task.</p>

<p>I turned to <strong>Docker</strong> to save the day.</p>

<h2 id="creating-a-build-container">Creating a build container</h2>

<p>My build server required the following tools to be installed:</p>

<ul>
  <li>PHP 7.x</li>
  <li>Composer</li>
  <li>Node.js</li>
  <li>Grunt</li>
  <li>Bower</li>
</ul>

<p>Transitively, for SASS parsing, I subsequently found I needed:</p>

<ul>
  <li>Ruby</li>
</ul>

<h3 id="php-and-composer-build-time">PHP and Composer (build time)</h3>

<p>Given this was used at <em>build time</em>, I wasn’t concerned about having a bloated image so I decided to go for a full PHP installation as the base image. I used the latest PHP image (on Alpine) for my build environment (which I gave the label “buildenv”).</p>

<pre><code class="language-docker">FROM php:7.4.1-alpine AS buildenv
</code></pre>

<p>Unfortunately, Composer isn’t included by default and while I could follow the Composer installation instructions, we only need the final ‘composer’ binary file. Luckily, there’s an official Composer image to use. So we reference that image in our layers, and copy the composer binary over into our buildenv.</p>

<pre><code class="language-docker">FROM composer:1.9.1 AS composer 
FROM php:7.4.1-alpine AS buildenv 
COPY --from=composer /usr/bin/composer /usr/bin/composer
</code></pre>

<p>At this stage, we have an Alpine 3.10 operating system with PHP 7.4.1 and Composer 1.9 available.</p>

<h3 id="nodejs-grunt-bower-build-time">Node.js, Grunt, Bower (build time)</h3>

<p>Building upon the previous layer, I then looked to the other build tools I required. These I grouped into a single layer, and installed the packages and ensured npm was up to date. Job done.</p>

<pre><code class="language-docker">RUN apk add --update nodejs npm &amp;&amp; \
    npm update -g npm &amp;&amp; \
    npm install -g grunt-cli &amp;&amp; \
    npm install -g bower 
</code></pre>

<h3 id="ruby-build-time">Ruby (build time)</h3>

<p>A bit of trial and error determined that the sass parser required Ruby. This is in its own layer to keep it separate while I worked out the packages I needed to install. More than I thought and remembered.</p>

<pre><code class="language-docker">RUN apk add --update ruby ruby-bundler ruby-dev \
    ruby-rdoc build-base gcc &amp;&amp; \
    gem install sass
</code></pre>

<h3 id="create-a-working-directory">Create a working directory</h3>

<p>I always like to do everything inside a working directory, so I create /app and work inside here for all subsequent stages.</p>

<pre><code class="language-docker">RUN mkdir /app 
WORKDIR /app
</code></pre>

<h3 id="downloading-the-application-dependencies">Downloading the application dependencies</h3>

<p>Remarkable looking back at all of the stages to get through before we can commence the application build. In summary, we have these steps for downloading the build time and runtime dependencies we require;</p>

<ol>
  <li>
    <p><strong>npm install</strong> — download the javascript build libraries into node_modules</p>
  </li>
  <li>
    <p><strong>composer install</strong> — PHP server side runtime dependencies, such as Twig and Symfony.</p>
  </li>
  <li>
    <p><strong>bower update</strong> — download all the client side runtime libraries, such as jQuery.</p>
  </li>
</ol>

<pre><code class="language-docker"># Copy npm dependencies
COPY package.json .
RUN npm install  

# Copy composer and download dependencies
COPY composer.json .
RUN composer install 

# Copy bower and download dependencies
RUN apk add --update git
RUN echo '{ "allow_root": true }' &gt; /root/.bowerrc
COPY bower.json .
RUN bower update
</code></pre>

<p>To briefly explain the above techniques.</p>

<ul>
  <li>
    <p>I copy only the files needed for the job (e.g. package.json, composer.json, or bower.json) — that’s so that I can isolate changes and limit recreating layers unnecessarily. Some of these steps can take 5 minutes to complete so I don’t want to trigger a full rebuild because I changed an unrelated file.</p>
  </li>
  <li>
    <p>Bower — needs git, so this stage I added that. Secondly, bower throws a warning when it is run as ‘root’ user — so the second line suppresses that.</p>
  </li>
</ul>

<p>So now we have a build environment that has an Alpine 3.10 operating system with PHP 7.4.1 and Composer 1.9 available. It has the latest versions of nodejs, grunt, and bower, and we have downloaded all the build-time and runtime dependencies that we require.</p>

<p>I think now we’re ready to build the application.</p>

<h3 id="building-the-application">Building the application</h3>

<p>In Docker terms, this may feel like an anticlimax. Because I’m using grunt, the existing build-all task that I created back in 2015 will still do the job.</p>

<pre><code class="language-docker"># Copy all the remaining source code
COPY src/ /app/src
COPY Gruntfile.js .
RUN grunt build-all
</code></pre>

<p>This is where all the work is done. You can skip this if you want, but I’ve shared so you can see the original build task. You might find this snippet useful to take some concepts into your own project.</p>

<p>In summary, what we are doing is:</p>

<ol>
  <li>
    <p>cleaning our build directory</p>
  </li>
  <li>
    <p>concatenating all javascript source code into a single file.</p>
  </li>
  <li>
    <p>obfuscating the javascript code</p>
  </li>
  <li>
    <p>using sass parser to create our css stylesheets</p>
  </li>
  <li>
    <p>minifying the css stylesheets</p>
  </li>
  <li>
    <p>copying all our javascript and css, third party css, and fonts over to our final distribution directory</p>
  </li>
  <li>
    <p>copy all server-side source code into the directory ready for Composer</p>
  </li>
  <li>
    <p>update version number placeholder</p>
  </li>
  <li>
    <p>run Composer to create an optimized production-ready runtime</p>
  </li>
</ol>

<p>It wasn’t all plain sailing when I upgraded my libraries to their latest version. Some changes were easy, sure, but a few required code updates — after all, I had to accommodate 5 years of deprecated features and changes. But all in all, it wasn’t as painful as I expected.</p>

<pre><code class="language-javascript">module.exports = function (grunt) {

    // Project configuration.
    grunt.initConfig({
        pkg: grunt.file.readJSON('package.json'),
        clean: {
            all: {
                src: ["dist", "tmp", ".sass-cache"],
                options: {
                    force: true
                }
            },
            web: {
                src: ["dist/web", "dist/templates", "dist/compilation_cache", "dist/doctrine_cache", "tmp", ".sass-cache"],
                options: {
                    force: true
                }
            }
        },
        jshint: {
            all: ['src/js/*.js']
        },
        concat: {
            all: {
                src: ['src/js/*.js'],
                dest: 'tmp/js/&lt;%= pkg.name %&gt;.js'
            }
        },
        sass: {
            dist: {
                files: {
                    'tmp/css/&lt;%= pkg.name %&gt;.css': 'src/scss/main.scss'
                }
            }
        },
        cssmin: {
            target: {
                options: {
                    banner: '/*! &lt;%= pkg.name %&gt; &lt;%= grunt.template.today("yyyy-mm-dd") %&gt; */'
                },
                files: [{
                    expand: true,
                    cwd: 'tmp/css/',
                    src: ['*.css', '!*.min.css'],
                    dest: 'dist/web/css/',
                    ext: '.min.css'
                }]
            }
        },
        uglify: {
            options: {
                banner: '/*! &lt;%= pkg.name %&gt; &lt;%= grunt.template.today("yyyy-mm-dd") %&gt; */\n'
            },
            build: {
                src: 'tmp/js/&lt;%= pkg.name %&gt;.js',
                dest: 'dist/web/js/&lt;%= pkg.name %&gt;.min.js'
            }
        },
        bowercopy: {
            javascript: {
                options: {
                    destPrefix: 'dist/web/js'
                },
                files: {
                    'jquery.min.js': 'jquery/dist/jquery.min.js',
                    'bootstrap.min.js': 'bootstrap/dist/js/bootstrap.min.js',
                    'html5shiv.min.js': 'html5shiv/dist/html5shiv.min.js',
                    'respond.min.js': 'respond/dest/respond.min.js',
                    'underscore.min.js': 'underscore/underscore-min.js',
                    'jquery.dataTables.min.js': 'datatables.net/js/jquery.dataTables.min.js',
                    'dataTables.bootstrap.min.js': 'datatables.net-bs/js/dataTables.bootstrap.min.js'
                }
            },
            css: {
                options: {
                    destPrefix: 'dist/web/css'
                },
                files: {
                    'bootstrap.min.css': 'bootstrap/dist/css/bootstrap.min.css',
                    'bootstrap-theme.min.css': 'bootstrap/dist/css/bootstrap-theme.min.css',
                    'font-awesome.min.css': 'components-font-awesome/css/font-awesome.min.css',
                    'dataTables.bootstrap.min.css': 'datatables.net-bs/css/dataTables.bootstrap.min.css'
                }
            },
            bootstrap_fonts: {
                files: {
                    'dist/web/fonts': 'bootstrap/dist/fonts/*.*'
                }
            },
            font_awesome_fonts: {
                files: {
                    'dist/web/fonts': 'components-font-awesome/fonts/*.*'
                }
            }
        },
        copy: {
            main: {
                files: [
                    {expand: true, cwd: 'src/php/web/', src: ['**'], dest: 'dist/web/'},
                    {expand: true, cwd: 'src/php/lib/', src: ['**'], dest: 'dist/lib/'},
                    {expand: true, cwd: 'src/static/', src: ['**'], dest: 'dist/web/'},
                    {expand: true, cwd: 'src/ico/', src: ['**'], dest: 'dist/web/ico/'},
                    {expand: true, cwd: 'src/img/', src: ['**'], dest: 'dist/web/img/'},
                    {expand: true, cwd: 'src/css/', src: ['**'], dest: 'dist/web/css/'},
                    {expand: true, cwd: 'src/config/', src: ['**'], dest: 'dist/config/'},
                    {expand: true, cwd: 'src/templates/', src: ['**'], dest: 'dist/templates/'},
                    {src: ['composer.json'], dest: 'dist/'}
                ]
            }
        },
        composer: {
            dist: {
                options: {
                    cwd: 'dist'
                }
            }
        },
        'string-replace': {
            version: {
                files: {
                    'dist/config/settings.ini': 'dist/config/settings.ini'
                },
                options: {
                    replacements: [{
                        pattern: '%APPLICATION_VERSION%',
                        replacement: '&lt;%= pkg.version %&gt;-&lt;%= grunt.template.today("yyyymmdd") %&gt;'
                    }]
                }
            }
        }
    });

    grunt.loadNpmTasks('grunt-contrib-clean');
    grunt.loadNpmTasks('grunt-contrib-concat');
    grunt.loadNpmTasks('grunt-contrib-sass');
    grunt.loadNpmTasks('grunt-contrib-jshint');
    grunt.loadNpmTasks('grunt-contrib-uglify');
    grunt.loadNpmTasks('grunt-contrib-cssmin');
    grunt.loadNpmTasks('grunt-composer');
    grunt.loadNpmTasks('grunt-bowercopy');
    grunt.loadNpmTasks('grunt-contrib-copy');
    grunt.loadNpmTasks('grunt-string-replace');

    grunt.registerTask('build-all', ['clean:all', 'concat', 'uglify', 'sass', 'cssmin', 'bowercopy', 'copy', 'string-replace:version', 'composer:dist:install:optimize-autoloader', 'composer:dist:update:optimize-autoloader']);

    grunt.registerTask('build-web', ['clean:web', 'concat', 'uglify', 'sass', 'cssmin', 'bowercopy', 'copy', 'string-replace:version']);

    grunt.registerTask('run-composer', ['composer:dist:install:optimize-autoloader', 'composer:dist:update:optimize-autoloader']);

};
</code></pre>

<p>At this stage we have a buildenv containing a directory <code>/app/dist/</code> with all our final build output ready to be run.</p>

<h2 id="building-the-runtime-image">Building the runtime image</h2>

<p>So far everything we have done is in our ‘buildenv’. But we don’t want all this bloatware in our final image. So we start again with a slim operating system, and I chose Alpine.</p>

<p>On top of that, we need PHP but this time we only need a small subset of the PHP packages to run this application (your mileage will vary). And for this particular runtime, we still have Nginx.</p>

<p>As you will see later, I am also using <em>supervisor</em> to manage the processes to ensure php-fpm and nginx are kept running.</p>

<pre><code class="language-docker"># Create final image
FROM alpine:3.11.0 

# Install packages 
RUN apk upgrade &amp;&amp; apk --no-cache add php7 php7-fpm \
    php7-json php7-openssl \
    nginx supervisor curl
</code></pre>

<h3 id="configuration">Configuration</h3>

<p>Our three processes each need some configuration, so we copy those into place in the image. These trivial configuration files have been shared in the <a href="https://github.com/davelms/medium-articles/tree/master/php-to-docker">example repository on GitHub</a>.</p>

<p>In summary, the configuration is simply to allow Nginx to listen on port 8080 and redirect requests to php-fpm to handle.</p>

<pre><code class="language-docker"># Configure nginx 
COPY config/nginx.conf /etc/nginx/nginx.conf 

# Configure php-fpm 
COPY config/fpm-pool.conf /etc/php7/php-fpm.d/www.conf 
COPY config/php.ini /etc/php7/conf.d/zzz_custom.ini   

# Configure supervisord 
COPY config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf
</code></pre>

<h3 id="use-nobody-user-to-own-directories">Use nobody user to own directories</h3>

<p>We’re using the ‘nobody’ user, so we need to ensure directory permissions are aligned.</p>

<pre><code class="language-docker">RUN chown -R nobody.nobody /run &amp;&amp; \
    chown -R nobody.nobody /var/lib/nginx &amp;&amp; \
    chown -R nobody.nobody /var/log/nginx
</code></pre>

<p>We now have our runtime image, with PHP and Nginx installed and configured. But we still need our application.</p>

<h3 id="copy-the-final-distribution-from-the-build-environment">Copy the final distribution from the build environment</h3>

<p>Let’s create the directory <code>/var/www/html</code> and switch to the nobody user, then copy all the distribution contents over from the ‘buildenv’.</p>

<pre><code class="language-docker"># Setup document root 
RUN mkdir -p /var/www/html   

# Switch to use a non-root user from here on 
USER nobody 

# Add application 
WORKDIR /var/www/html 
COPY --chown=nobody --from=buildenv /app/dist/ /var/www/html/
</code></pre>

<h3 id="expose-the-port">Expose the port</h3>

<p>Nearly at the end now — we need to expose the port that Nginx will be reachable on.</p>

<pre><code class="language-docker"># Expose the port nginx is reachable on 
EXPOSE 8080
</code></pre>

<h3 id="ensure-services-are-running">Ensure services are running</h3>

<p>The final stage now is to use supervisord to ensure that Nginx and php-fpm are running and able to serve requests.</p>

<pre><code class="language-docker"># Let supervisord start nginx &amp; php-fpm 
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>And that’s it — we can build the image and run it locally. Our runtime has a low footprint because we used a slim base image and only installed the absolute bare-minimum packages we required to run our application.</p>

<p>Your situation will obviously be different, the libraries you use may be more complex — but I hope the overview gives a sense of what can be accomplished.</p>

<p>For <strong>build automation</strong>, I then combined **GitHub **with **DockerHub **so that future commits automatically kick off a build and the creation of a new versioned image.</p>

<p>And I deployed that into <strong>Google Cloud Run</strong>, where the exact same image I ran on my laptop I could also happily run in Production.</p>

<p>I killed off my Amazon EC2 “classic” micro instance after almost 6 years, and reduced the cost of running to pennies a year.</p>

<p>And by choosing Docker, I had a maintainable platform to keep on top of.</p>

<h3 id="the-final-dockerfile">The final Dockerfile</h3>

<p>I ended up with a single Dockerfile, applying the <a href="https://docs.docker.com/develop/develop-images/multistage-build/">Docker multi-stage build technique</a>, and ultimately created a cut-down, slim runtime image. I could have consolidated a few layers, and break out, but once the initial set up was done, I could spin out new images in under a minute so I left it all as one.</p>

<pre><code class="language-dockerfile">FROM composer:1.9.1 AS composer

FROM php:7.4.1-alpine AS buildenv

COPY --from=composer /usr/bin/composer /usr/bin/composer

RUN apk add --update nodejs npm &amp;&amp; \
    npm update -g npm &amp;&amp; \
    npm install -g grunt-cli &amp;&amp; \
    npm install -g bower

RUN apk add --update ruby ruby-bundler ruby-dev ruby-rdoc build-base gcc &amp;&amp; \
    gem install sass

RUN mkdir /app 
WORKDIR /app

# Copy npm dependencies
COPY package.json .
RUN npm install 

# Copy composer and download dependencies
COPY composer.json .
RUN composer install

# Copy bower and download dependencies
RUN apk add --update git
RUN echo '{ "allow_root": true }' &gt; /root/.bowerrc
COPY bower.json .
RUN bower update 

# Copy all the remaining source code
COPY src/ /app/src
COPY Gruntfile.js .
RUN grunt build-all

# Create final image
FROM alpine:3.11.0

# Install packages 
RUN apk upgrade &amp;&amp; apk --no-cache add php7 php7-fpm php7-json php7-openssl \
    nginx supervisor curl

# Configure nginx 
COPY config/nginx.conf /etc/nginx/nginx.conf

# Configure PHP-FPM 
COPY config/fpm-pool.conf /etc/php7/php-fpm.d/www.conf 
COPY config/php.ini /etc/php7/conf.d/zzz_custom.ini  

# Configure supervisord 
COPY config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Make sure files/folders needed by the processes are accessable when they run under the nobody user 
RUN chown -R nobody.nobody /run &amp;&amp; \   
    chown -R nobody.nobody /var/lib/nginx &amp;&amp; \
    chown -R nobody.nobody /var/log/nginx

# Setup document root 
RUN mkdir -p /var/www/html  

# Create cache directories
RUN mkdir /var/www/html/compilation_cache &amp;&amp; chown nobody.nobody /var/www/html/compilation_cache &amp;&amp; \
    mkdir /var/www/html/doctrine_cache &amp;&amp; chown nobody.nobody /var/www/html/doctrine_cache

# Switch to use a non-root user from here on 
USER nobody

# Add application 
WORKDIR /var/www/html 
COPY --chown=nobody --from=buildenv /app/dist/ /var/www/html/

# Expose the port nginx is reachable on 
EXPOSE 8080  

# Let supervisord start nginx &amp; php-fpm 
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]  

# Configure a healthcheck to validate that everything is up &amp; running 
HEALTHCHECK --timeout=10s CMD curl --silent --fail http://127.0.0.1:8080/fpm-ping
</code></pre>

<h2 id="a-note-from-the-author">A note from the author</h2>

<p>Thank you for reading this article — I hope you found this article useful and I look forward to your comments and feedback.</p>

<p>Source code is available from this <a href="https://github.com/davelms/medium-articles/tree/master/php-to-docker">example repository on GitHub</a>.</p>

<p>You can follow me on <a href="https://twitter.com/davelms">Twitter</a> and connect on <a href="https://www.linkedin.com/in/davelms/">LinkedIn</a>.</p>

</div>

<!-- Rating -->


<!-- Author Box if enabled from _config.yml -->
<!-- Author Box -->


<div class="d-flex authorbox align-items-center">
    <div class="col-md-2 mr-4 text-center">
        
        <img class="author-thumb" src="https://www.gravatar.com/avatar/519b6d839ac5d2ae8bdaa85b8152da40?s=250&d=mm&r=x" alt="Dave">
        
    </div>
    <div class="col-md-10"> 
        <a target="_blank" class="text-dark h4" href="https://www.davelms.co.uk">About Dave</a>   <a target="_blank" href="https://twitter.com/davelms" class="btn-sm"><i class="fab fa-twitter"></i></a>        
        <span class="author-description d-block mt-2">DevOps | AWS | GCP.  Editor of Goats in Trees.</span>            
    </div>
</div>



<!-- Comments if not disabled with comments: false -->
<!-- Comments
================================================== -->


<!-- Share -->
<div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Convert an old PHP application to Docker containers&url=/convert-an-old-php-application-to-docker-containers/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=/convert-an-old-php-application-to-docker-containers/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=/convert-an-old-php-application-to-docker-containers/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>

    </ul>
</div>


<!-- Related Post -->
<!-- Related Posts
================================================== -->
<div class=" related-posts ">  

    
    <h2 class="text-center mb-4">Explore more like this</h2>
    
    
    <div class="d-flex justify-content-center align-items-center">
    
    <!-- Categories -->
    
    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/categories#DevOps">DevOps</a>                
    

    <!-- Tags -->  
    
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#PHP">PHP</a>               
                    
    <a class="smoothscroll badge badge-primary text-capitalize" href="/tags#docker">docker</a>               
    

    </div>

    
    
    
    <div class="blog-grid-container">
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/use-ansible-to-create-and-configure-ec2-instances-on-aws/">
                

                
                <img class="img-thumb"
                    src="/assets/images/use-ansible-to-create-and-configure-ec2-instances-on-aws/bill-oxford--fGqsewtsJY-unsplash.jpg"
                    alt="Use Ansible to create and configure EC2 instances on AWS">
                

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/use-ansible-to-create-and-configure-ec2-instances-on-aws/">Use Ansible to create and configure EC2 instances on AWS</a>
                
            </h2>
            <h4 class="card-text">Quick how to tutorial to using Ansible to stand up EC2 instances on AWS. Over the next 5 minutes, we’ll create an initial jumpbox in our default VPC and install...</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                    
                    <img class="author-thumb" src="https://www.gravatar.com/avatar/519b6d839ac5d2ae8bdaa85b8152da40?s=250&d=mm&r=x"
                        alt="Dave">
                    
                </span>
                <span class="author-meta">
                    <span class="post-name"><a target="_blank"
                            href="https://www.davelms.co.uk">Dave</a></span>
                    
                    <span class="post-date">25 Apr 2020</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
            <!-- begin post -->


<div class="blog-grid-item">
    <div class="card h-100">
        <div class="maxthumb">
            <a href="/schedule-aws-lambda-to-download-a-file-from-the-internet-and-save-it-to-s3/">
                

                
                <img class="img-thumb"
                    src="/assets/images/schedule-aws-lambda-to-download-a-file-from-the-internet-and-save-it-to-s3/1_RhGZIe05Pj_kjGPDbBOmqQ.jpeg"
                    alt="Schedule cron in Lambda to download a file and save it to S3">
                

                
            </a>
        </div>
        <div class="card-body">
            <h2 class="card-title">
                <a class="text-dark" href="/schedule-aws-lambda-to-download-a-file-from-the-internet-and-save-it-to-s3/">Schedule cron in Lambda to download a file and save it to S3</a>
                
            </h2>
            <h4 class="card-text">How to write an AWS Lambda (Node.js) function and schedule it daily to download a file from the internet and save it into an S3 bucket.</h4>
        </div>
        <div class="card-footer bg-white">
            <div class="wrapfooter">
                
                <span class="meta-footer-thumb">
                    
                    <img class="author-thumb" src="https://www.gravatar.com/avatar/519b6d839ac5d2ae8bdaa85b8152da40?s=250&d=mm&r=x"
                        alt="Dave">
                    
                </span>
                <span class="author-meta">
                    <span class="post-name"><a target="_blank"
                            href="https://www.davelms.co.uk">Dave</a></span>
                    
                    <span class="post-date">06 Apr 2020</span>
                </span>
                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>
<!-- end post -->
            
            
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        
            
            
        
            
        
            
        
        
        </div>        
</div>

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

            </div>

            
            <!-- Newsletter
    ================================================== -->
            <div class="newsletter text-center">
                <span class="h4"><img src="/assets/images/goat-logo.png" class="newsletter-logo"
                        alt="Goats in Trees"> &nbsp; Never miss a <b>story</b> from us, subscribe to our
                    newsletter</span>
                <form action="https://goatsintrees.us8.list-manage.com/subscribe/post?u=f1ba23fce94cc889510e995fd&amp;id=b045064b1d" method="post" name="mc-embedded-subscribe-form"
                    class="wj-contact-form validate" target="_blank" novalidate>
                    <div class="mc-field-group d-inline-flex">
                        <input type="email" placeholder="Your e-mail" name="EMAIL" class="required email" id="mce-EMAIL"
                            autocomplete="on" required>
                        <input type="submit" value="Subscribe" name="subscribe" class="heart">
                    </div>
                </form>
            </div>
            

        </div>

        <!-- Begin Footer
================================================== -->
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 col-sm-12 text-center text-lg-left">
                        Copyright © 2020 Goats in Trees
                    </div>
                </div>
            </div>
        </footer>
        <!-- End Footer
================================================== -->

    </div> <!-- /.site-content -->

    <!-- Scripts (if you need bootstrap.js, please add it yourself. I didn't use it for performance reasons, it was not needed in this theme)
================================================== -->

    <script src="/assets/js/prism.js"></script>

    <script src="/assets/js/theme.js"></script>

    

    
    <script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>
    

</body>

</html>